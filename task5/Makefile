PHONY: build run test clean migrate test setup test-booking test-expiry test-concurrency help

help:
	@echo "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ñ†ÐµÐ»Ð¸:"
	@echo "  make setup     - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ€ÐµÐ´Ñ‹ (Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹)"
	@echo "  make test      - Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ñ‚ÐµÑÑ‚Ð¾Ð²"
	@echo "  make test-booking - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
	@echo "  make test-expiry - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑ€Ð¾ÐºÐ° Ð±Ñ€Ð¾Ð½Ð¸"
	@echo "  make test-concurrency - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°"
	@echo "  make clean     - ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²"
	@echo "  make help      - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ"

build:
	docker compose build

run:
	docker compose up

lint:
	golangci-lint run ./...
	go vet ./...

rebuild:
	docker compose down -v
	docker compose up --build

stop:
	docker compose down

logs:
	docker compose logs -f app

clean: test_clean
	docker compose down -v
	rm -f event_booker
	@echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
	@rm -f .admin_token .user1_token .user2_token .event_id .booking1_code .booking2_code 2>/dev/null || true

sql_connect:
	docker exec -it task5-postgres-1 psql -U postgres -d eventbooker

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
SERVER_URL := http://localhost:8080
ADMIN_EMAIL := admin@eventbooker.com
USER1_EMAIL := user1@eventbooker.com
USER2_EMAIL := user2@eventbooker.com
PASSWORD := password123
EVENT_NAME := "Test Event with Short Expiry"
SHORT_LIFESPAN := "1m"  # ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐºÑÐ¿Ð¸Ñ€Ð°Ñ†Ð¸Ð¸

# Ð¦ÐµÐ»Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
test: setup test-booking test-expiry test-concurrency
	@echo "âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

setup: test_clean
	@echo "ðŸ”„ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ€ÐµÐ´Ñ‹..."
	
	# Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
	@echo "ðŸ‘¤ Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°..."
	@curl -s -X POST $(SERVER_URL)/register \
		-H "Content-Type: application/json" \
		-d '{"email":"$(ADMIN_EMAIL)","password":"$(PASSWORD)","name":"Admin User"}' | \
		jq -r '.user.id' > .admin_id
	@echo "Admin ID: $$(cat .admin_id)"
	@sleep 1
	
	# Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 1
	@echo "ðŸ‘¤ Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 1..."
	@curl -s -X POST $(SERVER_URL)/register \
		-H "Content-Type: application/json" \
		-d '{"email":"$(USER1_EMAIL)","password":"$(PASSWORD)","name":"Test User 1"}' | \
		jq -r '.token' > .user1_token
	@echo "User1 Token: $$(cat .user1_token)"
	@sleep 1
	
	# Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 2  
	@echo "ðŸ‘¤ Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 2..."
	@curl -s -X POST $(SERVER_URL)/register \
		-H "Content-Type: application/json" \
		-d '{"email":"$(USER2_EMAIL)","password":"$(PASSWORD)","name":"Test User 2"}' | \
		jq -r '.token' > .user2_token
	@echo "User2 Token: $$(cat .user2_token)"
	@sleep 1
	
	# Ð›Ð¾Ð³Ð¸Ð½ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°	
	@echo "ðŸ” Ð›Ð¾Ð³Ð¸Ð½ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°..."
	@curl -s -X POST $(SERVER_URL)/login \
		-H "Content-Type: application/json" \
		-d '{"email":"$(ADMIN_EMAIL)","password":"$(PASSWORD)"}' | \
		jq -r '.token' > .admin_token
	@echo "Admin Token: $$(cat .admin_token)"
	@sleep 1
	
	@echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"

test-booking:
	@echo "ðŸŽ« Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
	
	# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
	@echo "ðŸ“… Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ..."
	@curl -s -X POST $(SERVER_URL)/events \
		-H "Authorization: Bearer $$(cat .admin_token)" \
		-H "Content-Type: application/json" \
		-d '{"name":$(EVENT_NAME),"date":"2025-12-25T19:00:00Z","total_seats":10,"life_span":"15m"}' | \
		jq -r '.event.id' > .event_id
	@echo "Event ID: $$(cat .event_id)"
	@sleep 1
	
	# Ð‘Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¼ÐµÑÑ‚Ð° Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 1
	@echo "ðŸŽŸï¸ Ð‘Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ 2 Ð¼ÐµÑÑ‚Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 1..."
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .event_id)/book \
		-H "Authorization: Bearer $$(cat .user1_token)" \
		-H "Content-Type: application/json" \
		-d '{"seat_count":2}' | \
		jq -r '.booking.booking_code' > .booking1_code
	@echo "Booking Code 1: $$(cat .booking1_code)"
	@sleep 1
	
	# Ð‘Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¼ÐµÑÑ‚Ð° Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 2
	@echo "ðŸŽŸï¸ Ð‘Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ 3 Ð¼ÐµÑÑ‚Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 2..."
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .event_id)/book \
		-H "Authorization: Bearer $$(cat .user2_token)" \
		-H "Content-Type: application/json" \
		-d '{"seat_count":3}' | \
		jq -r '.booking.booking_code' > .booking2_code
	@echo "Booking Code 2: $$(cat .booking2_code)"
	@sleep 1
	
	# ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÐµÐ¼ Ð±Ñ€Ð¾Ð½ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 1
	@echo "âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÐµÐ¼ Ð±Ñ€Ð¾Ð½ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 1..."
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .event_id)/confirm \
		-H "Authorization: Bearer $$(cat .user1_token)" \
		-H "Content-Type: application/json" \
		-d '{"booking_code": "$$(cat .booking1_code)"}'
	@sleep 1
	
	# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¼ÐµÑÑ‚Ð° (Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ 5)
	@echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¼ÐµÑÑ‚Ð°..."
	@curl -s -X GET $(SERVER_URL)/events/$$(cat .event_id) | \
		jq -r '.event.available_seats' > .available_seats
	@if [ "$$(cat .available_seats)" -eq 5 ]; then \
		echo "âœ… Ð¢ÐµÑÑ‚ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½!"; \
	else \
		echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¾Ð¶Ð¸Ð´Ð°Ð»Ð¾ÑÑŒ 5 Ð¼ÐµÑÑ‚, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ $$(cat .available_seats)"; \
		exit 1; \
	fi

test-expiry:
	@echo "â° Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑ€Ð¾ÐºÐ° Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
	
	# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ñ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¼ ÑÑ€Ð¾ÐºÐ¾Ð¼ Ð¶Ð¸Ð·Ð½Ð¸ Ð±Ñ€Ð¾Ð½Ð¸
	@echo "ðŸ“… Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ñ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¼ ÑÑ€Ð¾ÐºÐ¾Ð¼ Ð¶Ð¸Ð·Ð½Ð¸ (1 Ð¼Ð¸Ð½ÑƒÑ‚Ð°)..."
	@curl -s -X POST $(SERVER_URL)/events \
		-H "Authorization: Bearer $$(cat .admin_token)" \
		-H "Content-Type: application/json" \
		-d '{"name":"Short Expiry Event","date":"2025-12-25T20:00:00Z","total_seats":5,"life_span":"$(SHORT_LIFESPAN)"}' | \
		jq -r '.event.id' > .short_event_id
	@echo "Short Event ID: $$(cat .short_event_id)"
	@sleep 1
	
	# Ð‘Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¼ÐµÑÑ‚Ð¾, Ð½Ð¾ ÐÐ• Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÐµÐ¼ ÐµÐ³Ð¾
	@echo "ðŸŽŸï¸ Ð‘Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¼ÐµÑÑ‚Ð¾ Ð±ÐµÐ· Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ..."
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .short_event_id)/book \
		-H "Authorization: Bearer $$(cat .user2_token)" \
		-H "Content-Type: application/json" \
		-d '{"seat_count":1}' | \
		jq -r '.booking.booking_code' > .expiry_booking_code
	@echo "Expiry Booking Code: $$(cat .expiry_booking_code)"
	@sleep 1
	
	# Ð–Ð´ÐµÐ¼ 70 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑ€Ð¾ÐºÐ°
	@echo "â³ Ð–Ð´ÐµÐ¼ 70 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑ€Ð¾ÐºÐ° Ð±Ñ€Ð¾Ð½Ð¸..."
	@sleep 70
	
	# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼ÐµÑÑ‚Ð¾ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ð»Ð¾ÑÑŒ
	@echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ð»Ð¾ÑÑŒ Ð»Ð¸ Ð¼ÐµÑÑ‚Ð¾..."
	@curl -s -X GET $(SERVER_URL)/events/$$(cat .short_event_id) | \
		jq -r '.event.available_seats' > .available_after_expiry
	@if [ "$$(cat .available_after_expiry)" -eq 5 ]; then \
		echo "âœ… Ð¢ÐµÑÑ‚ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÑ€Ð¾ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½!"; \
	else \
		echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð±Ñ€Ð¾Ð½ÑŒ Ð½Ðµ Ð±Ñ‹Ð»Ð° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"; \
		exit 1; \
	fi

test-concurrency:
	@echo "âš¡ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ð¾Ð³Ð¾ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
	
	# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ð¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾Ð¼ Ð¼ÐµÑÑ‚
	@echo "ðŸ“… Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ñ 3 Ð¼ÐµÑÑ‚Ð°Ð¼Ð¸..."
	@curl -s -X POST $(SERVER_URL)/events \
		-H "Authorization: Bearer $$(cat .admin_token)" \
		-H "Content-Type: application/json" \
		-d '{"name":"Concurrency Test Event","date":"2025-12-25T21:00:00Z","total_seats":3,"life_span":"5m"}' | \
		jq -r '.event.id' > .concurrent_event_id
	@echo "Concurrent Event ID: $$(cat .concurrent_event_id)"
	@sleep 1
	
	# ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð·Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¼ÐµÑÑ‚, Ñ‡ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾
	@echo "ðŸŽŸï¸ ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð·Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ 4 Ð¼ÐµÑÑ‚Ð° (Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾)..."
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .concurrent_event_id)/book \
		-H "Authorization: Bearer $$(cat .user1_token)" \
		-H "Content-Type: application/json" \
		-d '{"seat_count":4}' | \
		jq -r '.error' > .error_response
	@if [ "$$(cat .error_response)" = "Not enough available seats" ]; then \
		echo "âœ… Ð¢ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¼ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½!"; \
	else \
		echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ð»Ð° Ð·Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¼ÐµÑÑ‚ Ñ‡ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾"; \
		exit 1; \
	fi
	@sleep 1
	
	# Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ð¾Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð´Ð½Ð¸Ñ… Ð¸ Ñ‚ÐµÑ… Ð¶Ðµ Ð¼ÐµÑÑ‚
	@echo "ðŸŽ¯ Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ð¾Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ..."
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .concurrent_event_id)/book \
		-H "Authorization: Bearer $$(cat .user1_token)" \
		-H "Content-Type: application/json" \
		-d '{"seat_count":2}' > /tmp/user1_booking.log &
	@sleep 0.5
	
	@curl -s -X POST $(SERVER_URL)/events/$$(cat .concurrent_event_id)/book \
		-H "Authorization: Bearer $$(cat .user2_token)" \
		-H "Content-Type: application/json" \
		-d '{"seat_count":2}' > /tmp/user2_booking.log &
	@sleep 0.5
	
	# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
	@wait
	@sleep 1
	
	# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð½ÑÑ‚Ñ‹Ñ… Ð¼ÐµÑÑ‚
	@curl -s -X GET $(SERVER_URL)/events/$$(cat .concurrent_event_id) | \
		jq -r '.event.available_seats' > .final_seats
	@if [ "$$(cat .final_seats)" -ge 0 ] && [ "$$(cat .final_seats)" -le 3 ]; then \
		echo "âœ… Ð¢ÐµÑÑ‚ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½!"; \
	else \
		echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ñ‹Ð¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼"; \
		exit 1; \
	fi

test_clean:
	@echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
	@rm -f .admin_token .user1_token .user2_token .event_id .booking1_code .booking2_code \
	       .admin_id .short_event_id .expiry_booking_code .available_seats \
	       .available_after_expiry .concurrent_event_id .error_response .final_seats \
	       /tmp/user1_booking.log /tmp/user2_booking.log 2>/dev/null || true

.PHONY: test setup test-booking test-expiry test-concurrency test_clean